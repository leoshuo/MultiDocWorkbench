# 经验沉淀工作台（后端管理界面）使用与操作手册

版本：1.6.4

> 本手册面向后端管理人员与交付运维人员。前台用户端请参考 `docs/quickstart/QUICK_REFERENCE.md`。

## 1.6.4 版本更新

### 核心功能增强

#### Replay 智能跳过机制
- **业务级 pass 状态**：Replay 时如果未找到符合录制要求的输入源信息，返回 `pass` 状态（区别于系统级 `fail`）
- **目标内容保护**：pass 时目标位置内容保持不变，不会被错误覆盖
- **双工作台提示**：在两个工作台都显示跳过原因说明

#### 沉淀校验模式
- **新增 validationMode 字段**：每个沉淀可设置"强校验"（🔒）或"不校验"（🔓）模式
- **强校验**：要求在当前文档中找到与录制时相似的内容特征，未找到则 pass
- **不校验**（默认）：不做严格校验，努力找到目标位置并执行

#### 统一沉淀编辑
- **弹窗编辑模式**：点击沉淀的"编辑"按钮，弹出完整编辑弹窗
- **移除内联编辑**：删除沉淀列表中每个 section 的单独编辑/编译功能
- **编辑保存**：修改后保存即替换原沉淀记录

### Bug 修复
- **React key 重复警告**：修复沉淀列表渲染时的 `key` 重复问题
- **布局持久化**：修复切换工作台后布局配置丢失的问题
- **面板调整**：修复编辑模式下底部/右侧调整被阻挡的问题

### UI 改进
- **操作调度输入框**：高度可垂直拖拽调整，并自动持久化
- **沉淀校验标签**：每个 section 旁显示校验模式标记（🔒/🔓）
- **pass 状态样式**：新增 pass 状态视觉区分

---

## 1.6.3 版本更新

### 核心修复
- **统一应用端与后管端 Replay 逻辑**：确保点击应用端按钮与后管端沉淀集 Replay 结果完全一致
- **修复 dispatch API 响应处理**：正确处理 `{ summary, detail, edits, usedModel }` 响应格式
- **修复 insert_to_summary 输入获取**：扩写类操作现在从当前大纲获取目标标题的摘要作为输入
- **代码精简约1000行**：删除冗余函数和被禁用的代码块

### Replay 执行结果详细显示
- LLM Replay Done - 大模型成功执行
- LLM Replay Done（兼容性执行，差异：...）- 有差异但成功
- Script Replay Done（大模型回退原因：...）- 大模型失败回退
- Script Replay Done - 纯脚本执行

### 其他改进
- **执行指令沉淀增强**：详细记录动作描述、指令内容、输入/输出内容、目标位置、AI指导等
- **大纲展开/收起**：每个标题支持展开/收起其下级标题
- **新增标题继承级别**：新增标题自动继承参考标题的级别
- **UI 布局优化**：
  - 模式选择 tab 字体加大（16px）
  - 沉淀列表/沉淀集列表标签字体加大（15px）
  - 功能按钮栏紧凑布局，减少空白

## 1. 界面定位

| 工作台 | 定位 | 入口 |
|--------|------|------|
| 前台用户端 | 多文档处理工作台（面向普通用户） | 默认界面 |
| 后端管理端 | 经验沉淀工作台（面向沉淀/配置人员） | 点击"切换后台管理工作台" |

**数据全局共享**：文档、沉淀、沉淀集、按钮配置、布局编辑都持久化在 `data/`，切换工作台不清空。

## 2. 模式配置流程（必须按顺序）

界面顶部四个模式为顺序配置链路：

```
大纲配置 -> 沉淀配置 -> 应用端按钮配置 -> 自迭代配置
```

| 模式 | 功能 |
|------|------|
| 大纲配置 | 大纲抽取、历史大纲应用 |
| 沉淀配置 | 沉淀记录/沉淀集管理、Replay |
| 应用端按钮配置 | 前台对话按钮与沉淀集关联 |
| 自迭代配置 | 策略参数（可选） |

## 3. 术语定义

| 术语 | 说明 |
|------|------|
| Section | 每次按钮点击自动生成的记录，包含5部分：输入来源、动作执行、执行摘要、记录位置、特殊按钮复现方式；可编辑与编号 |
| 沉淀记录 | 由多个 Section 汇总形成；支持重命名、编辑、排序 |
| 沉淀集 | 可将多条沉淀合并为一个集合，支持增删改与 Replay |
| 自动沉淀 | 用户点击"自动沉淀"开始，点击"结束沉淀"结束并生成沉淀记录 |
| Replay | 按沉淀或 Section 顺序复现；支持脚本 Replay 与大模型 Replay |

**执行状态**：
- 沉淀级：`done` / `partial done` / `fail`
- Section级：`done` / `pass` / `fail`
  - `pass` 表示模型做了泛化妥协但仍完成该步骤
  - `fail` 必须给出失败原因

## 4. 面板与数据

- **文档列表与来源面板**：与多文档处理工作台共用同一数据
- 任何一侧上传/删除/清除文档，两端都会同步
- 文档列表右上角提供"清除"按钮，一键清空已添加文件

## 5. 大纲配置操作

### 大纲抽取
1. 选择文档
2. 点击"全文大纲抽取"
3. AI 自动分析生成层级大纲（支持1-5级）
4. 可编辑大纲标题和摘要

### 大纲历史
- 点击"历史大纲"查看存档
- 支持恢复、重命名、删除历史大纲
- 大纲会自动存档到 `data/outline-history.json`

### 大纲缓存
- 大纲在工作台切换时保持不变
- 大纲在 Replay 时保持不变
- 仅 server 重启时清空缓存

## 6. 沉淀配置操作

### 自动沉淀
- 默认使用"大模型沉淀"，若按钮配置有特殊要求则按配置执行
- 每条沉淀可切换"脚本沉淀/大模型沉淀"模式

### 排序与编辑
- **排序**：支持拖拽与点击编号修改执行顺序
- **编辑**：名称、【操作记录】、【动作执行】、【执行摘要】、【记录位置】均可编辑
- **回车确认**：所有编辑内容均可通过回车确认
- 编辑后除名称外的字段需经大模型编译为 Replay Meta，并持久化到数据库

### Replay模式
| 模式 | 特点 |
|------|------|
| 大模型沉淀 | 允许泛化，适应不同场景 |
| 脚本沉淀 | 严格一致，不一致直接 pass 并报错原因 |

## 7. 沉淀集

- 点击"沉淀集列表"打开沉淀集管理
- 支持新增/更新/重命名/删除、Replay
- 沉淀集中的每条沉淀仍可单独编辑与 Replay

## 8. 应用端按钮配置

### 配置方式
- 两列配置：左侧为前台按钮，右侧为可选沉淀集
- 选择按钮后，勾选关联沉淀集并保存
- 保存后：前台对话按钮将触发对应沉淀集的 Replay
- 保存需提示成功/失败，结果写入 `data/`

### 默认前台按钮
| 按钮 | 功能 |
|------|------|
| 日报合并写作（主任版） | 合并多份日报生成汇总 |
| 竞品分析报告写作 | 生成竞品分析报告 |
| 自定义写作 | 自定义写作任务 |

### 配置生效机制
- **配置加载**：每次载入页面时从 `data/multi-app-buttons.json` 刷新最新沉淀集配置
- **保存生效**：点击保存后对应用端立即生效
- **Replay触发**：点击生效的按钮 = 触发该按钮下勾选的沉淀集进行 Replay

## 9. 后管页面按钮逻辑重配

- 入口位于经验沉淀工作台顶部
- 通过弹窗查看与配置后管页面按钮逻辑
- 支持 AI 生成按钮逻辑
- 保存后即刻生效并持久化

## 10. 编辑布局与样式

### 编辑能力
- 拖拽移动面板
- 调整面板尺寸
- 修改按钮样式
- 隐藏/显示面板

### 持久化
- 位置/尺寸/颜色等属性均持久化
- 本地存储+服务端双重保障
- 退出编辑不丢失布局
- 支持重置为默认配置

## 11. 现场配置（可留空项）

以下内容如未知可留空，现场可通过 `.env`、命令行参数或运行时接口修改：

| 配置项 | 环境变量 | 说明 |
|--------|----------|------|
| 模型接口地址 | `QWEN_ENDPOINT` | 千问/兼容接口地址 |
| 模型名称 | `QWEN_MODEL` | 默认 qwen-plus |
| API Key | `QWEN_API_KEY` | 离线模型可留空，可用 `--api-key=...` 或 `POST /api/config/api-key` |

### 现场修改方法
1. 修改 `.env` 后重启后端服务
2. 启动命令追加 `--api-key=...` 参数
3. 运行时调用 `POST /api/config/api-key`
4. 容器环境可通过 `docker run -e` 或容器管理平台设置环境变量

> 注意：`.env` 为本地私密配置文件，请勿提交到 Git。

更多沉淀细节请见：`docs/SOP_DEPOSIT_GUIDE.md`


